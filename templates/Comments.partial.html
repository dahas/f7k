<div class="container-sm mt-3">
    {if isset($isReply)}
    <p id="add">
        <a data-bs-toggle="collapse" href="#collapseExample" role="button" aria-expanded="true"
            aria-controls="collapseExample">
            <i class="bi bi-chat-left-text"></i> Leave a comment
        </a>
    </p>
    <div class="collapse show" id="collapseExample">
        <h2 id="comments" class="mt-4">{$form_header}</h2>
        <form method="post" action="{$route}/Reply/create">
            <input type="hidden" name="comment_id" value="{$comment_id}">
            <input type="hidden" name="controller" value="{$route}">
            <input type="hidden" name="redirect" value="{$route}">
            <div class="card mb-3">
                <div class="card-body">
                    <div class="row mb-3">
                        <div n:if="isset($isLoggedIn) && !$isLoggedIn" class="col-12 ps-3 pt-2">
                            Please log in to leave a comment.
                        </div>
                        <div n:if="isset($isLoggedIn) && $isLoggedIn" class="col-12 ps-4 pt-2">
                            Signed in as: <b>{$user['name']}</b>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col">
                            <textarea id="simple-mde-editor" name="comment" class="form-control text-bg-light" rows="4"
                                placeholder="Your comment here ...">{$text ?? ''}</textarea>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Submit</button>
                    <a href="{$route}#comments" type="button" class="btn btn-secondary">Cancel</a>
                </div>
            </div>
        </form>
    </div>
    {elseif isset($isReplyUpdate)}
    <p id="add">
        <a data-bs-toggle="collapse" href="#collapseExample" role="button" aria-expanded="true"
            aria-controls="collapseExample">
            <i class="bi bi-chat-left-text"></i> Leave a comment
        </a>
    </p>
    <div class="collapse show" id="collapseExample">
        <h2 id="comments" class="mt-4">{$form_header}</h2>
        <form method="post" action="{$route}/Reply/update">
            <input type="hidden" name="comment_id" value="{$comment_id}">
            <input type="hidden" name="id" value="{$id}">
            <input type="hidden" name="controller" value="{$route}">
            <input type="hidden" name="redirect" value="{$route}">
            <div class="card mb-3">
                <div class="card-body">
                    <div class="row mb-3">
                        <div n:if="isset($isLoggedIn) && !$isLoggedIn" class="col-12 ps-3 pt-2">
                            Please log in to leave a comment.
                        </div>
                        <div n:if="isset($isLoggedIn) && $isLoggedIn" class="col-12 ps-4 pt-2">
                            Signed in as: <b>{$user['name']}</b>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col">
                            <textarea id="simple-mde-editor" name="comment" class="form-control text-bg-light" rows="4"
                                placeholder="Your comment here ...">{$text ?? ''}</textarea>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Submit</button>
                    <a href="{$route}#comments" type="button" class="btn btn-secondary">Cancel</a>
                </div>
            </div>
        </form>
    </div>
    {elseif isset($isUpdate)}
    <p id="add">
        <a data-bs-toggle="collapse" href="#collapseExample" role="button" aria-expanded="true"
            aria-controls="collapseExample">
            <i class="bi bi-chat-left-text"></i> Leave a comment
        </a>
    </p>
    <div class="collapse show" id="collapseExample">
        <h2 id="comments" class="mt-4">{$form_header}</h2>
        <form method="post" action="{$route}/Comments/update">
            <input type="hidden" name="comment_id" value="{$comment_id}">
            <input type="hidden" name="controller" value="{$route}">
            <input type="hidden" name="redirect" value="{$route}">
            <div class="card mb-3">
                <div class="card-body">
                    <div class="row mb-3">
                        <div n:if="isset($isLoggedIn) && !$isLoggedIn" class="col-12 ps-3 pt-2">
                            Please log in to leave a comment.
                        </div>
                        <div n:if="isset($isLoggedIn) && $isLoggedIn" class="col-12 ps-4 pt-2">
                            Signed in as: <b>{$user['name']}</b>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col">
                            <textarea id="simple-mde-editor" name="comment" class="form-control text-bg-light" rows="4"
                                placeholder="Your comment here ...">{$text ?? ''}</textarea>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Submit</button>
                    <a href="{$route}#comments" type="button" class="btn btn-secondary">Cancel</a>
                </div>
            </div>
        </form>
    </div>
    {else}
    <p id="add">
        <a n:if="isset($isLoggedIn) && !$isLoggedIn" href="/Auth/login">
            <i class="bi bi-chat-left-text"></i> Login to leave a comment
        </a>
        <a n:if="isset($isLoggedIn) && $isLoggedIn" data-bs-toggle="collapse" href="#collapseExample" role="button"
            aria-expanded="{$expanded}" aria-controls="collapseExample">
            <i class="bi bi-chat-left-text"></i> Leave a comment
        </a>
    </p>
    <div class="collapse {$expanded ? 'show' : ''}" id="collapseExample">
        <form method="post" action="{$route}/Comments/create">
            <input type="hidden" name="controller" value="{$route}">
            <input type="hidden" name="redirect" value="{$route}">
            <div class="card mb-3">
                <div class="card-body">
                    <div class="row mb-3">
                        <div n:if="isset($isLoggedIn) && !$isLoggedIn" class="col-12 ps-3 pt-2">
                            Please log in to leave a comment.
                        </div>
                        <div n:if="isset($isLoggedIn) && $isLoggedIn" class="col-12 ps-4 pt-2">
                            Signed in as: <b>{$user['name']}</b>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col">
                            <textarea id="simple-mde-editor" name="comment" class="form-control text-bg-light" rows="4"
                                placeholder="Your comment here ...">{$text ?? ''}</textarea>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Submit</button>
                </div>
            </div>
        </form>
    </div>
    {/if}

    <h2 id="comments" class="mt-4" n:if="$comments">Comments</h2>

    <div id="C{$comment->id()}" class="card text-bg-light mb-3" n:foreach="$comments as $comment"
        n:if="!$comment->getHidden() || ($isLoggedIn && isset($user['email']) && $user['email']==$comment->getEmail())">
        <div class="card-header d-flex" style="font-size: 0.75rem;">
            <div>#{$comment->id()} | <b>{$comment->getName()}</b> wrote at {$comment->getCreated()}</div>
            <div n:if="isset($user['email']) && $user['email']==$comment->getEmail()" class="ms-auto">
                <a href="{$route}/Comments/edit?id={$comment->id()}" style="margin-right: 0.25rem"><i
                        class="bi bi-pencil-fill"></i></a>
                <a href="{$route}/Comments/hide?id={$comment->id()}" style="margin-right: 0.25rem"><i
                        class="bi {$comment->getHidden() ? 'text-secondary bi-eye-fill' : 'bi-eye-slash-fill'}"></i></a>
                <a href="{$route}/Comments/delete?id={$comment->id()}"><i class="bi bi-trash3-fill"></i></a>
            </div>
        </div>
        <div class="card-body">
            <div class="markdown">
                {$comment->getComment()|noescape|markdown}
            </div>

            <div id="R{$reply->id()}" class="card mb-3" n:foreach="$comment->getReplies() as $reply"
                n:if="!$reply->getHidden() || ($isLoggedIn && isset($user['email']) && $user['email']==$reply->getEmail())">
                <div class="card-header d-flex" style="font-size: 0.75rem;">
                    <div>#{$reply->id()} | <b>{$reply->getName()}</b> replied at {$reply->getCreated()}</div>
                    <div n:if="isset($user['email']) && $user['email']==$reply->getEmail()" class="ms-auto">
                        <a href="{$route}/Reply/edit?comment_id={$comment->id()}&amp;id={$reply->id()}"
                            style="margin-right: 0.25rem"><i class="bi bi-pencil-fill"></i></a>
                        <a href="{$route}/Reply/hide?comment_id={$comment->id()}&amp;id={$reply->id()}"
                            style="margin-right: 0.25rem"><i
                                class="bi {$reply->getHidden() ? 'text-secondary bi-eye-fill' : 'bi-eye-slash-fill'}"></i></a>
                        <a href="{$route}/Reply/delete?comment_id={$comment->id()}&amp;id={$reply->id()}"><i
                                class="bi bi-trash3-fill"></i></a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="markdown">
                        {$reply->getReply()|noescape|markdown}
                    </div>
                </div>
            </div>

            <a n:if="isset($isLoggedIn) && !$isLoggedIn" href="/Auth/login">
                <i class="bi bi-chat-left-text"></i> Login to reply</a>
            <a n:if="isset($isLoggedIn) && $isLoggedIn" href="{$route}/Reply?id={$comment->id()}#add">
                <i class="bi bi-chat-left-text"></i> Reply</a>
        </div>
    </div>
</div>